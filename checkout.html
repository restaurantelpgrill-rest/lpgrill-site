<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finalizar</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* BLOCO PAGAMENTO (leve, claro, padr√£o premium) */
    .paylock{
      margin-top:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.85);
    }
    .paylock-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .pay-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      color: rgba(35,20,25,.92);
      white-space: nowrap;
    }
    .pay-pill.ok{
      background: rgba(0,200,120,.12);
      border-color: rgba(0,200,120,.28);
      color: rgba(0,90,50,1);
    }
    .pay-pill.wait{
      background: rgba(214,179,106,.16);
      border-color: rgba(214,179,106,.30);
      color: rgba(80,55,15,1);
    }
    .pay-actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
    }
    .pay-note{
      margin-top:8px;
      font-size: 12px;
      opacity: .8;
      line-height: 1.5;
    }
    .hidden{ display:none !important; }
  </style>
</head>

<body class="app">

  <header class="pagebar">
    <a class="back" href="index.html">‚Üê Voltar ao Menu</a>
    <div class="page-title">
      <h1>Finalizar</h1>
      <p>Enviar no WhatsApp</p>
    </div>
    <span></span>
  </header>

  <main class="container">

    <!-- BLOQUEIO / STATUS PAGAMENTO -->
    <section class="paylock" id="payLockBox" aria-label="Pagamento">
      <div class="paylock-top">
        <strong>Pagamento</strong>
        <span id="payPill" class="pay-pill wait">‚è≥ Pendente</span>
      </div>

      <div id="payLockText" style="margin-top:6px; opacity:.85;">
        Verificando pagamento...
      </div>

      <div class="pay-actions">
        <a class="btn primary" id="goPayBtn" href="pagamento/pagamento.html" style="text-decoration:none;">
          Pagar agora (Pix)
        </a>
        <button class="btn light" id="btnResetPayment" type="button">Reset pagamento</button>
      </div>

      <div class="pay-note">
        O envio do pedido s√≥ libera quando o pagamento estiver <b>conclu√≠do</b> para o total atual.
      </div>
    </section>

    <!-- TOTAIS -->
    <div class="totals" style="margin-top:12px">
      <div class="row"><span>Subtotal</span><strong id="subTotal">R$ 0,00</strong></div>
      <div class="row"><span>Taxa</span><strong id="deliveryFee">R$ 0,00</strong></div>
      <div class="row total"><span>Total</span><strong id="grandTotal">R$ 0,00</strong></div>
      <div class="mini muted">‚è±Ô∏è Tempo m√©dio: <span id="etaText">30‚Äì60 min</span></div>
    </div>

    <!-- ITENS -->
    <div id="cartItems"></div>

    <!-- FORM -->
    <section class="checkout-form" style="margin-top:14px">
      <h2>Dados para entrega/retirada</h2>

      <label>Nome
        <input id="cName" type="text" placeholder="Seu nome" required>
      </label>

      <label>WhatsApp (cliente)
        <input id="cPhone" type="tel" placeholder="(31) 9xxxx-xxxx" required>
      </label>

      <label>Endere√ßo completo (obrigat√≥rio para entrega)
        <input id="cAddress" type="text" placeholder="Rua, n√∫mero, bairro, refer√™ncia">
      </label>

      <label>Observa√ß√µes
        <textarea id="cObs" rows="3" placeholder="Sem cebola, ponto da carne, etc."></textarea>
      </label>

      <div style="display:flex; gap:10px; margin-top:12px">
        <a class="btn light" href="index.html" style="flex:1">Voltar</a>
        <button class="btn primary" id="btnSendOrder" type="button" style="flex:1">
          Enviar pedido no WhatsApp
        </button>
      </div>

      <p class="muted" id="checkoutMsg" style="margin-top:10px"></p>
    </section>

  </main>

  <script src="js/data.js"></script>
  <script src="js/cart.js"></script>
  <script src="js/app.js"></script>

  <script>
  (() => {
    // === CHAVES DO SEU PROJETO ===
    const CART_KEY = "LPGRILL_CART_V3";
    const MODE_KEY = "LPGRILL_MODE_V3";
    const PAYMENT_KEY = "LPGRILL_PAYMENT_V1";

    const STORE_WA = "5531999999999"; // <<< coloque o WhatsApp real da loja aqui (DDI55)
    const money = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    const $ = (s)=> document.querySelector(s);

    const readCart = ()=>{ try{ return JSON.parse(localStorage.getItem(CART_KEY)||"{}"); }catch(e){ return {}; } };
    const readMode = ()=> (localStorage.getItem(MODE_KEY)||"entrega");

    function parseBRL(text){
      if(!text) return 0;
      const n = String(text)
        .replace(/\s/g,"")
        .replace("R$","")
        .replace(/\./g,"")
        .replace(",",".")
        .replace(/[^\d.]/g,"");
      return Number(n || 0);
    }

    function getTotalFromDOM(){
      const el = $("#grandTotal");
      if(!el) return 0;
      return parseBRL(el.textContent);
    }

    function isPaidForTotal(total){
      try{
        const raw = localStorage.getItem(PAYMENT_KEY);
        if(!raw) return false;
        const p = JSON.parse(raw);
        if(p?.status !== "paid") return false;

        const a = Number(p?.amount || 0);
        if(Math.abs(a - total) > 0.009) return false;

        // expira em 60 min
        const ageMs = Date.now() - Number(p?.paidAt || 0);
        if(ageMs > 60*60*1000) return false;

        return true;
      }catch(e){
        return false;
      }
    }

    function lockUI(locked, total){
      const pill = $("#payPill");
      const txt  = $("#payLockText");
      const btnSend = $("#btnSendOrder");

      if(pill){
        pill.classList.toggle("ok", !locked);
        pill.classList.toggle("wait", locked);
        pill.textContent = locked ? "‚è≥ Pendente" : "‚úÖ Conclu√≠do";
      }

      if(txt){
        txt.innerHTML = locked
          ? `‚ùå Pagamento n√£o conclu√≠do para o total <b>${money(total)}</b>. Clique em <b>Pagar agora</b>.`
          : `‚úÖ Pagamento conclu√≠do para o total <b>${money(total)}</b>. Voc√™ pode enviar o pedido.`;
      }

      if(btnSend){
        btnSend.disabled = locked;
        btnSend.style.opacity = locked ? ".55" : "";
        btnSend.style.pointerEvents = locked ? "none" : "";
      }
    }

    function buildCatalog(){
      // monta lista de produtos a partir do window.DATA
      const all = [];
      for(const k in window.DATA){
        if(Array.isArray(window.DATA[k])) all.push(...window.DATA[k]);
      }
      return all;
    }

    function renderCartAndTotals(){
      const cart = readCart();
      const mode = readMode();
      const fee = (mode === "entrega") ? 5 : 0;

      const all = buildCatalog();
      const find = (id)=> all.find(p => p.id === id);

      let sub = 0;

      const wrap = $("#cartItems");
      const entries = Object.entries(cart);

      wrap.innerHTML = entries.map(([id,q])=>{
        const p = find(id);
        if(!p) return "";
        sub += p.price * q;

        return `
          <div class="citem">
            <div class="citem-top">
              <div>
                <div class="cname">${p.title}</div>
                <div class="cdesc">${q} √ó ${money(p.price)}</div>
              </div>
              <strong>${money(p.price*q)}</strong>
            </div>
          </div>`;
      }).join("") || `<div class="muted" style="padding:10px 2px">Seu carrinho est√° vazio.</div>`;

      $("#subTotal").textContent = money(sub);
      $("#deliveryFee").textContent = money(fee);
      $("#grandTotal").textContent = money(sub + fee);
      $("#etaText").textContent = "30‚Äì60 min";

      // trava se n√£o tiver pago para o total atual
      const total = sub + fee;
      lockUI(!isPaidForTotal(total), total);

      return { cart, sub, fee, total, all, find, mode };
    }

    function validateForm(mode){
      const name = ($("#cName").value || "").trim();
      const phone = ($("#cPhone").value || "").trim();
      const address = ($("#cAddress").value || "").trim();

      if(!name) return { ok:false, msg:"Informe seu nome." };
      if(!phone) return { ok:false, msg:"Informe seu WhatsApp." };
      if(mode === "entrega" && !address) return { ok:false, msg:"Informe o endere√ßo (entrega)." };

      return { ok:true, name, phone, address };
    }

    function encodeWA(text){
      return encodeURIComponent(text);
    }

    // Intercepta envio se tentar for√ßar (extra seguran√ßa)
    function hardBlockIfNotPaid(total){
      if(!isPaidForTotal(total)){
        alert("Finalize o pagamento no Pix para liberar o pedido.");
        window.location.href = "pagamento/pagamento.html";
        return true;
      }
      return false;
    }

    // Init render
    let state = renderCartAndTotals();

    // Revalida periodicamente (se carrinho mudar em outra aba)
    setInterval(() => { state = renderCartAndTotals(); }, 700);
    window.addEventListener("storage", () => { state = renderCartAndTotals(); });

    // Reset pagamento (admin/uso interno)
    $("#btnResetPayment").addEventListener("click", ()=>{
      localStorage.removeItem(PAYMENT_KEY);
      state = renderCartAndTotals();
    });

    // Enviar pedido
    $("#btnSendOrder").addEventListener("click", ()=>{
      state = renderCartAndTotals();

      if(!Object.keys(state.cart).length){
        alert("Seu carrinho est√° vazio.");
        return;
      }

      if(hardBlockIfNotPaid(state.total)) return;

      const form = validateForm(state.mode);
      const msgEl = $("#checkoutMsg");
      if(!form.ok){
        msgEl.textContent = form.msg;
        return;
      }
      msgEl.textContent = "";

      const obs = ($("#cObs").value || "").trim();

      // Monta mensagem completa
      let msg = "";
      msg += "üçî *Pedido LP Grill*%0A";
      msg += `üë§ Nome: ${form.name}%0A`;
      msg += `üì± WhatsApp: ${form.phone}%0A`;
      msg += `üöö Modalidade: ${state.mode.toUpperCase()}%0A`;

      if(state.mode === "entrega"){
        msg += `üìç Endere√ßo: ${form.address}%0A`;
      }else{
        msg += `üìç Endere√ßo: (Retirar na loja)%0A`;
      }

      msg += "%0Aüßæ *Itens*%0A";
      for(const [id,q] of Object.entries(state.cart)){
        const p = state.find(id);
        if(p) msg += `‚Ä¢ ${q}x ${p.title}%0A`;
      }

      msg += `%0ASubtotal: ${money(state.sub)}%0A`;
      msg += `Taxa: ${money(state.fee)}%0A`;
      msg += `*Total: ${money(state.total)}*%0A`;

      // pagamento
      try{
        const pay = JSON.parse(localStorage.getItem(PAYMENT_KEY)||"{}");
        msg += `%0A‚úÖ Pagamento: PIX (confirmado)%0A`;
        msg += `Valor pago: ${money(pay.amount || state.total)}%0A`;
      }catch(e){
        msg += `%0A‚úÖ Pagamento: PIX (confirmado)%0A`;
      }

      if(obs){
        msg += `%0Aüìù Obs: ${obs}%0A`;
      }

      const url = `https://wa.me/${STORE_WA}?text=${msg}`;
      window.open(url, "_blank");
    });

  })();
  </script>

</body>
</html>

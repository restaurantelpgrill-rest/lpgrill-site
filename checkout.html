<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Finalizar ‚Äî LP Grill</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ============================
       Checkout Page ‚Äî Premium (claro)
       ============================ */
    .paylock{
      margin-top:12px;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.90);
      box-shadow: 0 14px 36px rgba(0,0,0,.10);
    }
    .paylock-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .pay-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.95);
      color: rgba(35,20,25,.92);
      white-space: nowrap;
    }
    .pay-pill.ok{
      background: rgba(0,200,120,.12);
      border-color: rgba(0,200,120,.28);
      color: rgba(0,90,50,1);
    }
    .pay-pill.wait{
      background: rgba(214,179,106,.16);
      border-color: rgba(214,179,106,.30);
      color: rgba(80,55,15,1);
    }
    .pay-actions{
      display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
    }
    .pay-note{
      margin-top:10px;
      font-size: 12px;
      opacity: .85;
      line-height: 1.5;
    }
    .hidden{ display:none !important; }

    .ck-wrap{ margin-top: 14px; }
    .ck-grid{ display:grid; grid-template-columns: 1fr; gap: 10px; }

    .ck-row2{ display:grid; grid-template-columns: 1fr 140px; gap: 10px; }
    @media (max-width:560px){
      .ck-row2{ grid-template-columns: 1fr; }
    }

    .ck-help{
      font-size:12px;
      opacity:.78;
      margin-top:8px;
      line-height:1.45;
    }

    /* Sugest√µes de bairro */
    #bairroSug{
      margin-top:8px;
      display:none;
    }
    #bairroSug .wrap{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.98);
      box-shadow: 0 12px 28px rgba(0,0,0,.10);
    }
    #bairroSug button{
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      color:#111;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
    }
  </style>
</head>

<body class="app">

  <header class="pagebar">
    <a class="back" href="index.html">‚Üê Voltar ao Menu</a>
    <div class="page-title">
      <h1>Finalizar</h1>
      <p>Pagamento Pix ‚Ä¢ Endere√ßo ‚Ä¢ WhatsApp</p>
    </div>
    <span></span>
  </header>

  <main class="container">

    <!-- BLOQUEIO / STATUS PAGAMENTO -->
    <section class="paylock" id="payLockBox" aria-label="Pagamento">
      <div class="paylock-top">
        <strong>Pagamento</strong>
        <span id="payPill" class="pay-pill wait">‚è≥ Pendente</span>
      </div>

      <div id="payLockText" style="margin-top:8px; opacity:.88;">
        Verificando pagamento...
      </div>

      <div class="pay-actions">
        <a class="btn primary" id="goPayBtn" href="pagamento/pagamento.html" style="text-decoration:none;">
          Pagar agora (Pix)
        </a>
        <button class="btn light" id="btnResetPayment" type="button">Reset pagamento</button>
      </div>

      <div class="pay-note">
        O envio do pedido s√≥ libera quando o pagamento estiver <b>conclu√≠do</b> para o <b>total atual</b>.
      </div>
    </section>

    <!-- TOTAIS -->
    <div class="totals" style="margin-top:12px">
      <div class="row"><span>Subtotal</span><strong id="subTotal">R$ 0,00</strong></div>
      <div class="row"><span>Taxa</span><strong id="deliveryFee">R$ 0,00</strong></div>
      <div class="row total"><span>Total</span><strong id="grandTotal">R$ 0,00</strong></div>
      <div class="mini muted">‚è±Ô∏è Tempo m√©dio: <span id="etaText">30‚Äì60 min</span></div>
    </div>

    <!-- ITENS -->
    <div id="cartItems"></div>

    <!-- FORM (premium) -->
    <section class="checkout-form ck-wrap">
      <h2>Dados para entrega/retirada</h2>

      <div class="ck-grid">
        <label>Nome
          <input id="cName" type="text" placeholder="Seu nome" required>
        </label>

        <label>WhatsApp (cliente)
          <input id="cPhone" type="tel" placeholder="(31) 9xxxx-xxxx" required>
        </label>

        <div class="ck-row2">
          <label>Rua
            <input id="cRua" type="text" placeholder="Ex: Rua Jo√£o Lemos">
          </label>

          <label>N√∫mero
            <input id="cNum" type="text" placeholder="Ex: 74">
          </label>
        </div>

        <label>Bairro (com sugest√£o)
          <input id="cBairro" type="text" placeholder="Digite: s√£o..." autocomplete="off">
          <div id="bairroSug"></div>
          <div class="ck-help" id="feeHint">Taxa: ‚Äî</div>
        </label>

        <label>Complemento (opcional)
          <input id="cComp" type="text" placeholder="Apto, bloco...">
        </label>

        <label>Refer√™ncia (opcional)
          <input id="cRef" type="text" placeholder="Perto de...">
        </label>

        <label>Observa√ß√µes
          <textarea id="cObs" rows="3" placeholder="Sem cebola, ponto da carne, etc."></textarea>
        </label>
      </div>

      <div style="display:flex; gap:10px; margin-top:12px">
        <a class="btn light" href="index.html" style="flex:1">Voltar</a>
        <button class="btn primary" id="btnSendOrder" type="button" style="flex:1">
          Enviar pedido no WhatsApp
        </button>
      </div>

      <p class="muted" id="checkoutMsg" style="margin-top:10px"></p>
    </section>

  </main>

  <!-- ‚úÖ ORDEM CERTA: data ‚Üí render ‚Üí cart  (N√ÉO carregar app.js aqui) -->
  <script src="js/data.js"></script>
  <script src="js/render.js"></script>
  <script src="js/cart.js"></script>

  <script>
  (() => {
    // =========================
    // CHAVES DO PROJETO
    // =========================
    const CART_KEY    = "LPGRILL_CART_V3";
    const MODE_KEY    = "LPGRILL_MODE_V3";
    const FEE_KEY     = "LPGRILL_FEE_V1";          // ‚úÖ taxa real calculada pelo app/cart
    const PAYMENT_KEY = "LPGRILL_PAYMENT_V1";

    // ‚úÖ WhatsApp real da loja (DDI55)
    const STORE_WA = "5531998832407";

    const money = (v)=> Number(v||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
    const $ = (s)=> document.querySelector(s);

    const esc = (s)=> String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    const readCart = ()=>{ try{ return JSON.parse(localStorage.getItem(CART_KEY)||"{}"); }catch(e){ return {}; } };
    const readMode = ()=> (localStorage.getItem(MODE_KEY)||"entrega");

    function readFee(){
      const mode = readMode();
      if(mode !== "entrega") return 0;
      const f = Number(localStorage.getItem(FEE_KEY) || "0");
      return Number.isFinite(f) ? f : 0;
    }

    function parseBRL(text){
      if(!text) return 0;
      const n = String(text)
        .replace(/\s/g,"")
        .replace("R$","")
        .replace(/\./g,"")
        .replace(",",".")
        .replace(/[^\d.]/g,"");
      return Number(n || 0);
    }

    function getTotalFromDOM(){
      const el = $("#grandTotal");
      if(!el) return 0;
      return parseBRL(el.textContent);
    }

    function isPaidForTotal(total){
      try{
        const raw = localStorage.getItem(PAYMENT_KEY);
        if(!raw) return false;
        const p = JSON.parse(raw);
        if(p?.status !== "paid") return false;

        const a = Number(p?.amount || 0);
        if(Math.abs(a - total) > 0.009) return false;

        // expira em 60 min
        const ageMs = Date.now() - Number(p?.paidAt || 0);
        if(ageMs > 60*60*1000) return false;

        return true;
      }catch(e){
        return false;
      }
    }

    function lockUI(locked, total){
      const pill = $("#payPill");
      const txt  = $("#payLockText");
      const btnSend = $("#btnSendOrder");

      if(pill){
        pill.classList.toggle("ok", !locked);
        pill.classList.toggle("wait", locked);
        pill.textContent = locked ? "‚è≥ Pendente" : "‚úÖ Conclu√≠do";
      }

      if(txt){
        txt.innerHTML = locked
          ? `‚ùå Pagamento n√£o conclu√≠do para o total <b>${money(total)}</b>. Clique em <b>Pagar agora</b>.`
          : `‚úÖ Pagamento conclu√≠do para o total <b>${money(total)}</b>. Voc√™ pode enviar o pedido.`;
      }

      if(btnSend){
        btnSend.disabled = locked;
        btnSend.style.opacity = locked ? ".55" : "";
        btnSend.style.pointerEvents = locked ? "none" : "";
      }
    }

    function buildCatalog(){
      const all = [];
      for(const k in (window.DATA||{})){
        if(Array.isArray(window.DATA[k])) all.push(...window.DATA[k]);
      }
      return all;
    }

    function renderCartAndTotals(){
      const cart = readCart();
      const mode = readMode();
      const fee = (mode === "entrega") ? readFee() : 0;

      const all = buildCatalog();
      const find = (id)=> all.find(p => String(p.id) === String(id));

      let sub = 0;

      const wrap = $("#cartItems");
      const entries = Object.entries(cart);

      wrap.innerHTML = entries.map(([id,q])=>{
        const p = find(id);
        if(!p) return "";
        const price = Number(p.promo && p.promoPrice ? p.promoPrice : p.price) || 0;
        sub += price * Number(q||0);

        return `
          <div class="citem">
            <div class="citem-top">
              <div>
                <div class="cname">${esc(p.title)}</div>
                <div class="cdesc">${q} √ó ${money(price)}</div>
              </div>
              <strong>${money(price*Number(q||0))}</strong>
            </div>
          </div>`;
      }).join("") || `<div class="muted" style="padding:10px 2px">Seu carrinho est√° vazio.</div>`;

      $("#subTotal").textContent = money(sub);
      $("#deliveryFee").textContent = money(fee);
      $("#grandTotal").textContent = money(sub + fee);
      $("#etaText").textContent = "30‚Äì60 min";

      const total = sub + fee;
      lockUI(!isPaidForTotal(total), total);

      // atualiza dica da taxa
      const hint = $("#feeHint");
      if(hint){
        if(mode !== "entrega") hint.innerHTML = `Taxa: <b>${money(0)}</b> (retirada)`;
        else hint.innerHTML = `Taxa: <b>${money(fee)}</b> (entrega)`;
      }

      return { cart, sub, fee, total, all, find, mode };
    }

    function validateForm(mode){
      const name = ($("#cName").value || "").trim();
      const phone = ($("#cPhone").value || "").trim();

      const rua = ($("#cRua").value || "").trim();
      const num = ($("#cNum").value || "").trim();
      const bairro = ($("#cBairro").value || "").trim();
      const comp = ($("#cComp").value || "").trim();
      const ref  = ($("#cRef").value || "").trim();

      if(!name) return { ok:false, msg:"Informe seu nome." };
      if(!phone) return { ok:false, msg:"Informe seu WhatsApp." };

      if(mode === "entrega"){
        if(!rua || !num || !bairro){
          return { ok:false, msg:"Para entrega, preencha Rua, N√∫mero e Bairro." };
        }
      }

      return { ok:true, name, phone, rua, num, bairro, comp, ref };
    }

    function hardBlockIfNotPaid(total){
      if(!isPaidForTotal(total)){
        alert("Finalize o pagamento no Pix para liberar o pedido.");
        window.location.href = "pagamento/pagamento.html";
        return true;
      }
      return false;
    }
<!-- ===== PIX QR CODE ===== -->
<div id="pixBox" class="pix-box" hidden>

  <h3>Pagamento via Pix</h3>

  <img src="img/pix.png" alt="QR Code Pix" class="pix-img">

  <p class="pix-key">
    Chave Pix:
    <strong id="pixKey">31998064556</strong>
  </p>

  <button type="button" id="copyPix" class="pix-copy">
    Copiar chave Pix
  </button>

  <p class="pix-info">
    Ap√≥s o pagamento, envie o comprovante pelo WhatsApp para liberar seu pedido.
  </p>

</div>
    // =========================
    // Autocomplete bairro (usa lista do app.js? aqui vamos usar lista b√°sica pelo fee j√° calculado)
    // =========================
    const BAIRROS = [
      "Aar√£o Reis","Primeiro de Maio","Novo Aar√£o Reis","Heli√≥polis","S√£o Gabriel","Belmonte","Monte Azul",
      "Ribeiro de Abreu","Paulo VI","Nazar√©","Guarani","Tupi","Floramar","Minasl√¢ndia","Jaqueline","Juliana",
      "Jardim Felicidade","Copacabana","Serra Verde","Planalto","Capit√£o Eduardo","Itapo√£","Venda Nova (Centro)",
      "Rio Branco","Santa M√¥nica"
    ];

    function suggest(prefix){
      const p = String(prefix||"").trim().toLowerCase();
      if(!p) return [];
      const all = BAIRROS.slice();
      const starts = all.filter(n => n.toLowerCase().startsWith(p));
      const contains = all.filter(n => !n.toLowerCase().startsWith(p) && n.toLowerCase().includes(p));
      return [...starts, ...contains].slice(0, 8);
    }

    function bindBairro(){
      const inp = $("#cBairro");
      const box = $("#bairroSug");
      if(!inp || !box) return;

      function render(list){
        if(!list.length){
          box.style.display = "none";
          box.innerHTML = "";
          return;
        }
        box.style.display = "block";
        box.innerHTML = `
          <div class="wrap">
            ${list.map(n=>`<button type="button" data-b="${esc(n)}">${esc(n)}</button>`).join("")}
          </div>
        `;
      }

      const onInput = () => render(suggest(inp.value || ""));
      inp.addEventListener("input", onInput);
      inp.addEventListener("focus", onInput);

      box.addEventListener("click", (e)=>{
        const btn = e.target.closest("[data-b]");
        if(!btn) return;
        inp.value = btn.getAttribute("data-b") || "";
        render([]);
      });
    }

    // Init
    bindBairro();

    // Render inicial + revalida√ß√µes
    let state = renderCartAndTotals();
    setInterval(() => { state = renderCartAndTotals(); }, 700);
    window.addEventListener("storage", () => { state = renderCartAndTotals(); });

    // Reset pagamento
    $("#btnResetPayment").addEventListener("click", ()=>{
      localStorage.removeItem(PAYMENT_KEY);
      state = renderCartAndTotals();
    });

    // Enviar pedido
    $("#btnSendOrder").addEventListener("click", ()=>{
      state = renderCartAndTotals();

      if(!Object.keys(state.cart).length){
        alert("Seu carrinho est√° vazio.");
        return;
      }

      if(hardBlockIfNotPaid(state.total)) return;

      const form = validateForm(state.mode);
      const msgEl = $("#checkoutMsg");
      if(!form.ok){
        msgEl.textContent = form.msg;
        return;
      }
      msgEl.textContent = "";

      const obs = ($("#cObs").value || "").trim();

      // Monta mensagem
      let msg = "";
      msg += "üçî *Pedido LP Grill*%0A";
      msg += `üë§ Nome: ${encodeURIComponent(form.name)}%0A`;
      msg += `üì± WhatsApp: ${encodeURIComponent(form.phone)}%0A`;
      msg += `üöö Modalidade: ${encodeURIComponent(state.mode.toUpperCase())}%0A`;

      if(state.mode === "entrega"){
        const addr = `${form.rua}, N¬∫ ${form.num} ‚Äî ${form.bairro}`;
        msg += `üìç Endere√ßo: ${encodeURIComponent(addr)}%0A`;
        if(form.comp) msg += `üè¢ Compl.: ${encodeURIComponent(form.comp)}%0A`;
        if(form.ref)  msg += `üß≠ Ref.: ${encodeURIComponent(form.ref)}%0A`;
      }else{
        msg += `üìç Endere√ßo: (Retirar na loja)%0A`;
      }

      msg += "%0Aüßæ *Itens*%0A";
      for(const [id,q] of Object.entries(state.cart)){
        const p = state.find(id);
        if(p) msg += `‚Ä¢ ${q}x ${encodeURIComponent(p.title)}%0A`;
      }

      msg += `%0ASubtotal: ${encodeURIComponent(money(state.sub))}%0A`;
      msg += `Taxa: ${encodeURIComponent(money(state.fee))}%0A`;
      msg += `*Total: ${encodeURIComponent(money(state.total))}*%0A`;

      // pagamento
      try{
        const pay = JSON.parse(localStorage.getItem(PAYMENT_KEY)||"{}");
        msg += `%0A‚úÖ Pagamento: PIX (confirmado)%0A`;
        msg += `Valor pago: ${encodeURIComponent(money(pay.amount || state.total))}%0A`;
      }catch(e){
        msg += `%0A‚úÖ Pagamento: PIX (confirmado)%0A`;
      }

      if(obs){
        msg += `%0Aüìù Obs: ${encodeURIComponent(obs)}%0A`;
      }

      const url = `https://wa.me/${STORE_WA}?text=${msg}`;
      window.open(url, "_blank");
    });
  })();
  </script>
<!-- ===== LP GRILL: CHECKOUT OVERLAY ===== -->
<div id="checkoutOverlay" class="ck-overlay" aria-hidden="true">
  <div class="ck-modal" role="dialog" aria-modal="true" aria-label="Finalizar pedido">
    <header class="ck-head">
      <div class="ck-title">
        <strong>Finalizar pedido</strong>
        <span class="ck-sub">Escolha pagamento e confirme seus dados</span>
      </div>
      <button id="ckClose" class="ck-x" type="button" aria-label="Fechar">‚úï</button>
    </header>

    <!-- STEP: PAGAMENTO -->
    <section class="ck-step" data-step="pay">
      <div class="ck-card">
        <p class="ck-hint">Como voc√™ quer pagar?</p>

        <div class="ck-grid">
          <button class="ck-pay" type="button" data-pay="pix">
            <span class="ck-pay-title">PIX</span>
            <span class="ck-pay-desc">Copia e cola + QR Code</span>
          </button>

          <button class="ck-pay" type="button" data-pay="credit">
            <span class="ck-pay-title">Cart√£o (Cr√©dito)</span>
            <span class="ck-pay-desc">Pagar na entrega/retirada</span>
          </button>

          <button class="ck-pay" type="button" data-pay="debit">
            <span class="ck-pay-title">Cart√£o (D√©bito)</span>
            <span class="ck-pay-desc">Pagar na entrega/retirada</span>
          </button>
        </div>
      </div>

      <div class="ck-actions">
        <button id="ckCancel" class="ck-btn ghost" type="button">Cancelar</button>
      </div>
    </section>

    <!-- STEP: ENDERE√áO -->
    <section class="ck-step" data-step="addr" hidden>
      <div class="ck-card">
        <p class="ck-hint" id="ckKmHint">Toque em ‚ÄúUsar minha localiza√ß√£o (GPS)‚Äù para calcular a taxa.</p>

        <div id="ckFeeLine" class="ck-fee" hidden>
          <div><span>Dist√¢ncia</span> <strong id="ckKm">‚Äî</strong></div>
          <div><span>Taxa</span> <strong id="ckFee">‚Äî</strong></div>
        </div>

        <div id="ckBlocked" class="ck-blocked" hidden>
          Fora do raio de entrega. Entrega indispon√≠vel.
        </div>

        <button id="ckGetLocation" class="ck-btn full" type="button">
          Usar minha localiza√ß√£o (GPS)
        </button>

        <div class="ck-form">
          <label class="ck-field">
            <span>Nome</span>
            <input id="ckName" type="text" placeholder="Seu nome" autocomplete="name" />
          </label>

          <label class="ck-field">
            <span>Telefone (DDD)</span>
            <input id="ckPhone" type="tel" placeholder="31999999999" autocomplete="tel" />
          </label>

          <label class="ck-field">
            <span>Bairro</span>
            <input id="ckBairro" type="text" placeholder="Ex.: Santa Tereza" />
          </label>

          <label class="ck-field">
            <span>Endere√ßo</span>
            <input id="ckAddress" type="text" placeholder="Rua, n√∫mero, refer√™ncia" autocomplete="street-address" />
          </label>

          <label class="ck-field">
            <span>Complemento (opcional)</span>
            <input id="ckCompl" type="text" placeholder="Apto, bloco, casa..." />
          </label>

          <label class="ck-field">
            <span>Observa√ß√µes (opcional)</span>
            <textarea id="ckObs" rows="3" placeholder="Sem cebola, ponto da carne, etc."></textarea>
          </label>
        </div>
      </div>

      <div class="ck-actions split">
        <button id="ckBackFromAddr" class="ck-btn ghost" type="button">Voltar</button>
        <button id="ckConfirmOrder" class="ck-btn primary" type="button">Confirmar</button>
      </div>
    </section>

    <!-- STEP: PIX -->
    <section class="ck-step" data-step="pix" hidden>
      <div class="ck-card">
        <div class="ck-summary">
          <div class="ck-row"><span>Subtotal</span> <strong id="ckTotalPix">R$ 0,00</strong></div>
          <div class="ck-row"><span>Taxa</span> <strong id="ckFeePix">R$ 0,00</strong></div>
          <div class="ck-row total"><span>Total</span> <strong id="ckPixTotal">R$ 0,00</strong></div>
        </div>

        <div class="ck-qrwrap">
          <div id="ckQr" class="ck-qr">Gerando QR‚Ä¶</div>
        </div>

        <label class="ck-field">
          <span>C√≥digo PIX (copia e cola)</span>
          <textarea id="ckPixCode" rows="4" readonly></textarea>
        </label>

        <button id="ckCopyPix" class="ck-btn full" type="button">Copiar c√≥digo PIX</button>

        <div class="ck-note">
          Depois de pagar, toque em ‚ÄúJ√° paguei‚Äù e envie o comprovante no WhatsApp.
        </div>

        <button id="ckPaidPix" class="ck-btn full ghost" type="button">J√° paguei (enviar comprovante)</button>
      </div>

      <div class="ck-actions">
        <button id="ckBackFromPix" class="ck-btn ghost" type="button">Voltar</button>
      </div>
    </section>
  </div>
</div>
<!-- ===== /LP GRILL: CHECKOUT OVERLAY ===== -->
</body>
</html>
